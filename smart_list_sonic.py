import pylast

from db.db import *
from config import Config

logging.basicConfig(level=logging.DEBUG)

config = Config()

network = pylast.LastFMNetwork(api_key=config.lastfm.api_key, api_secret=config.lastfm.api_secret,
                               username=config.lastfm.username,
                               password_hash=pylast.md5(config.lastfm.password))

db = Database(config.db.driver_name, config.db.url, config.db.driver_lib_path)
db.update_database()

db.clear_playlist()
iter_artists = db.get_artists()
for a in iter_artists:
    artist = iter_artists.cur

    print(artist.name)
    iter_tracks = db.get_tracks(artist.name)
    for t in iter_tracks:
        cur = iter_tracks.cur
        try:
            track = network.get_track(cur.artist, cur.title)
            play_cnt = track.get_playcount()
            logging.debug(F"From Last.Fm: Track {track}, play count {play_cnt}")
            db.update_track(cur.id_, play_cnt)

        except Exception as e:
            logging.error(e)

    iter_tracks.close()

    playlist_id = db.add_playlist('admin', False, f'{artist.name} - the best', 'autogenerated')
    iter_top = db.get_artist_top_tracks(artist.name,
                                        config.top_artist_songs_playlist.playlist_max_length)
    top = []
    duration = 0
    for t in iter_top:
        top.append(iter_top.cur)
        duration += iter_top.cur.duration_seconds

    db.fill_playlist(playlist_id, top)
    db.update_playlist(playlist_id, len(top), duration)

iter_artists.close()
